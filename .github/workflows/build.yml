name: ğŸ® Build and Deploy Web Game

# When to run this workflow
on:
  push:
    branches: [ main, claude/* ]  # Run on push to main or Claude branches
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

# Required for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Environment variables
env:
  GODOT_VERSION: 4.3
  EXPORT_NAME: zelda-like-game

jobs:
  # ============================================================================
  # Export for Web (HTML5) and Deploy to GitHub Pages
  # ============================================================================
  export-web:
    name: ğŸŒ Build & Deploy Web
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.3
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: ğŸ”§ Setup export templates
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: ğŸ”¨ Build for Web
        run: |
          mkdir -v -p build/web
          godot --headless --verbose --export-release "Web" build/web/index.html

      - name: ğŸ“¤ Upload Web build as artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web
          retention-days: 14

      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        # Only deploy on push to main or claude/* branches (not on PRs)
        if: github.event_name == 'push'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/web
          force_orphan: true
